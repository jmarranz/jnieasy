<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Enhancer</title><meta name="generator" content="DocBook XSL Stylesheets V1.69.1"><link rel="start" href="index.html" title=""><link rel="up" href="index.html" title=""><link rel="prev" href="ar01s07.html" title="Definition of user defined JAVA NATIVE METHODS AND classes"><link rel="next" href="ar01s09.html" title="Java Code Generation"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Enhancer</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ar01s07.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ar01s09.html">Next</a></td></tr></table><hr></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id528585"></a>Enhancer</h2></div></div></div><p>User defined classes must be enhanced to be converted in native capable classes. The enhancer adds new code and modifies the byte code of the compiled class providing the transparent behavior of the native memory-Java memory synchronization.</p><p>Enhancement can be done on filesystem or on runtime (on class loading). </p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id528602"></a>Enhancement done on filesystem</h3></div></div></div><p>If the enhancement is done on filesystem, this task does not use the native memory and/or load user dynamic link libraries (except the framework&#8217;s DLL). </p><p>An enhanced .class in the filesystem does not need the XML enhancer descriptor file in runtime and can be distributed without it.</p><p>The enhancement process of a user defined class may need to create new (internal) native capable classes, theses classes are saved alongside the user defined .class; on runtime these classes are loaded automatically when necessary. </p><p>The enhancement task is usually performed using the NativeEnhancerCmd class in the command line or Ant task, or using the method: </p><p>NativeEnhancer.enhance(URL filePath,String outputDir)</p><p>In both cases, the enhancement is made in &#8220;batch&#8221; mode using a &#8220;root&#8221; XML file listing the XML descriptor files of classes to be enhanced. The name of this &#8220;root&#8221; XML file is not fixed.</p><p>The following example file (enhancer.xml) list all XML enhancer descriptor files of all user defined native capable classes used in this manual, all XML files are in the same directory in this example:</p><p>&lt;?xml version="1.0" encoding="UTF-8"?&gt;</p><p>&lt;!-- enhancer.xml --&gt;</p><p>&lt;jniEasyEnhancer version="1.1"&gt;</p><p>&lt;include file="AddTwoNumbersCallback.jnieasy.enh.xml" /&gt;</p><p>&lt;include file="AddTwoNumbersCallbackOutside.jnieasy.enh.xml" /&gt;</p><p>&lt;include file="AddTwoNumbersCallbackToOverride.jnieasy.enh.xml" /&gt; </p><p>&lt;include file="Dimension.jnieasy.enh.xml" /&gt; </p><p>&lt;include file="EnumWindowsProc.jnieasy.enh.xml" /&gt; </p><p>&lt;include file="IntArray2Dim.jnieasy.enh.xml" /&gt; </p><p>&lt;include file="MyCPPClassOnDLL.jnieasy.enh.xml" /&gt; </p><p>&lt;include file="MyCPPClassOnJava.jnieasy.enh.xml"/&gt; </p><p>&lt;include file="MyCPPClassOnJavaConstructorCallback.jnieasy.enh.xml"/&gt;</p><p>&lt;include file="MyCPPClassOnJavaDestroyCallback.jnieasy.enh.xml"/&gt; </p><p>&lt;include file="MyCPPClassOnJavaSubCallback.jnieasy.enh.xml"/&gt;</p><p>&lt;include file="MyStructure.jnieasy.enh.xml"/&gt; </p><p>&lt;include file="MyStructureArray.jnieasy.enh.xml"/&gt; </p><p>&lt;include file="PointerToString.jnieasy.enh.xml"/&gt;</p><p></p><p>&lt;include file="inc/enhancer2.xml" /&gt;</p><p>&lt;/jniEasyEnhancer&gt;</p><p></p><p>The file attribute of the include tag expects the relative file path, or the URL of a XML enhancer descriptor class file or another &#8220;root&#8221; enhancer file. The &#8220;inc/enhancer2.xml&#8221; is an example of &#8220;including&#8221; another XML file in the &#8220;inc&#8221; subdirectory of the current folder of the enhancer.xml file.</p><p>The syntax of the NativeEnhancerCmd command is:</p><p>java com.innowhere.jnieasy.core.NativeEnhancerCmd urlClassDescXML outputDir</p><p>Where urlClassDescXML is the URL of the XML root descriptor (or a specific class enhancer file) and outputDir is the root directory to write the enhanced classes (is highly recommended the same directory of the non enhanced .class files). But these is a very simplified command, the java interpreter must locate the .class archives (a classpath must be specified) and the JNIEasy DLL must be located (must be in the search path specified with the java.library.path property).</p><p>Is highly recommended to use Ant to perform the enhancement tasks. The Ant file build.xml provided with JNIEasy is a complete cross-platform example of Ant tasks, only a few variables of /conf/conf.properties file must be modified to setup a development environment of JNIEasy.</p><p>The XML descriptor root lists the classes to enhance, but a user defined native capable class being enhanced may need the native description of another user defined native class, if this user defined native class is not already enhanced (declared later in the list) the framework will search in the Java classpath to locate the XML enhancer descriptor file with the file name according the name rules and will enhance this class before (cyclic references are managed with no problem), more info in the On load enhancer section. If a class was already enhanced the enhancer does nothing (the .class file must be removed or the source class recompiled to re-enhance again a .class).</p><p>The content of the top most root file enhancer.xml is:</p><p>&lt;?xml version="1.0" encoding="UTF-8"?&gt;</p><p>&lt;!-- enhancer.xml --&gt;</p><p>&lt;jniEasyEnhancer version="1.1"&gt; </p><p></p><p>&lt;include file="manual/enhancer.xml" /&gt;</p><p>&lt;include file="win32exam/win32/enhancer.xml" /&gt; </p><p>&lt;/jniEasyEnhancer&gt;</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id528872"></a>On load enhancer</h3></div></div></div><p>The &#8220;on load enhancer&#8221; is an optional feature useful to avoid the filesystem enhancement of user defined native capable classes. The enhancement is performed in runtime using a special framework&#8217;s ClassLoader when the class is used first time. If you need a quick loading of your program this feature must not be used because the enhancement is a bit slow task (use the filesystem enhancement on development time).</p><p>The ClassLoader enhancer enhances the original non-enhanced .class file in memory before submitting the bytecode to the JVM using the ClassLoader.defineClass(String,byte[],int,int) method. To do the enhancement task the enhancer ClassLoader needs to locate the XML enhancer descriptor file of the class, the search is performed with the method ClassLoader.getResource(String) using the name convention of XML enhancer files, the XML file must be in the classpath; the most simple approach is to put in the same folder the XML and the .class files. </p><p>Example of &#8220;on load enhancer&#8221; activation:</p><p>NativeEnhancer enhancer = JNIEasy.get().getEnhancer();</p><p>ClassLoader myParentLoader = Thread.currentThread().getContextClassLoader();</p><p>String[] included = new String[] { "examples.manual.*" };</p><p>String[] excluded = new String[] { StartInterface.class.getName() };</p><p>ClassLoader enhancerCL = </p><p>enhancer.enableOnLoad(included,excluded,myParentLoader);</p><p>Class clsStart = </p><p>Class.forName("examples.manual.Start",true, enhancerCL); </p><p>// Start class implements StartInterface</p><p>StartInterface start = (StartInterface)clsStart.newInstance(); </p><p>start.run(); // method using native capable classes not enhanced </p><p>See Enhancer.enableOnLoad(String[],String[],ClassLoader) for more info.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ar01s07.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ar01s09.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Definition of user defined JAVA NATIVE METHODS AND classes </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Java Code Generation</td></tr></table></div></body></html>
